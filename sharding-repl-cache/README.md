# pymongo-api с шардированным MongoDB с 3мя репликами

## Как запустить

В текущей директории (`./sharding-repl-cache/`) подготовлен файл `compose.yaml`.

1. Запустить саму базу с ее репликами и кешем через compose.

Запускаем mongodb и приложение

```shell
docker compose up -d
```

2. Объединяем всю БД в систему (роутер, сервер конфигурации и шарды 1 и 2 вместе с кешем) и заполняем mongodb данными

```shell
./scripts/mongo-init.sh
```

Если у Вас возникла проблема (не полного чтения скрипта), то вероятно стоит вручную сделать сброс коллекции в БД:

```shell
docker compose exec -T mongos_router mongosh --port 27020
> use somedb;
> db.helloDoc.countDocuments(); # Должно быть "0". У меня бывало 2000+
> db.helloDoc.drop();

> db.helloDoc.countDocuments(); # Теперь должно быть "0"
> quit();
```

## Как проверить

### На локальной машине (запускал на ней)

Откройте в браузере `http://localhost:8080/docs`

Первый запрос к коллекции `helloDoc/users` длится более ±1 секунды. Второй и последующие менее 50 мс (у меня 12 мс)

### MongoDB Compass

1. Установить клиент MongoDB Compass.
2. Указать адрес соединения: `mongodb://localhost:27020`
3. Присоединиться и посмотреть коллекцию

![1740338902246](image/README/1740338902246.png)


## Доступные эндпоинты

Список доступных эндпоинтов, swagger http://<ip виртуальной машины>:8080/docs

## Схемы

Все схемы собраны в текущей папке в файл `Задание 3.drawio`. В вкладках схемы вы найдете:

- **mongo-sharding** описывает взаимосвязь шардов при управлении БД
- **mongo-sharding-repl** уточняет вариант, когда мы реплицирует данные внутри шардов (3 реплики на каждый)
- **sharding-repl-cache** добавляет к предыдущей схеме кеширующий инстанс Redis для ускорения обработки запросов
- **service_discovery+api-gateway** включает в схему api-gateway c consul для управления и направления запросов к разным инстансам приложения
- **+CDN** - кеширует данные приложения по регионам нахождения пользователей